# CAP Theorem

## CAP 定理とは

Web サービスを用いることを想定した分散コンピュータの間の情報複製に関する考え方。

概要は、CAP(一貫性、可用性、分断耐性)の全てを同時に保証することは困難であることを説明する理論のこと。

逆にいうと CA、CP、AP の組み合わせは同時に実現できるということでもある。

ブリュワーの定理とも言われるらしい。

## Consistency(一貫性)とは

一貫性とはノードに関係なく、全てのデータを読み込んでも、「最新のデータ」か「エラー」を返す性質のこと。

例として、ノード A(複製元),ノード B(複製先)間ででデータの複製が行われているとする。

A のノードでデータの更新がされたら、B のノードでも同じ状態に更新する。

A,B のノードで更新が終わった状態ならば、クライアントがノード A,B のどちらにデータを要求しても、最新のデータが返却される。

しかし、ノード B で更新が終了する前や更新が失敗した状態でクライアントがノード B にデータを要求すると**最新ではないデータ**を返却してしまう。

これでは一貫性が失われてしまうため、このような場合では**エラー**を返却することで、ノード A とノード B で返却するデータが違うという状況を防ぐことができる。

## Availability(可用性)とは

可用性とはノード障害が起きても生存ノードの機能性は損なわれないことを保証する性質のこと。

ノード A,B でデータが複製されているとして、ノード A が障害でダウンしたとする。

この時にノード A の障害の影響を受けずに、ノード B 単体でサービスを継続することができる。

このようなことを保証する性質を可用性という。

## Partition-Tolerance(分断耐性)とは

分断耐性とは、ネットワーク分断によって、ノードが分断されて互いに通信ができなくてもサービスを継続できることを保証する性質のこと。

## C/A/P の組み合わせについて

### CA パターンについて

CA パターンは一貫性と可用性は保証されるが、分断耐性は低いパターンのこと。

例として、ノード A,B があり、以下のような性質を持つとする。

- ノード A,B はネットワークで同期されている
- 一方のノードでデータが更新された場合、もう片方のノードも追随してデータを更新する

C,A を保証する場合は以下の設計が必要になる。

- データは常に最新のデータを返す(一貫性)
- 一方のノードがダウンしたときはもう片方のノードのみでサービスを継続する(可用性)

この設計の問題はノード間のネットワークが分断された場合、お互いの状態を知ることができなること。

つまり、**分断耐性がないために、分断された時は一貫性と可用性が損なわれてしまう**ことである。

## CP パターン

CP パターンは一貫性と分断耐性は保証されるが、可用性が低いパターンのこと。

いつもの例の通り、ノード A,B があり、持つ性質は CA パターンと同じとする。

この時、C,P を保証する場合は以下の設計が必要になる。

- ノード A,B 間のネットワークが分断された場合、アクセスされたデータが最新であることを保証できければエラーを返す

この設計の問題は一方のノードに障害が起きた場合、利用できないサービスが発生してしまうこと。

要は、最新データ出なければエラーを返すことから、片方でもノードが落ちると利用できないデータが出るため可用性が低下してしまう。

## AP パターン

AP パターンは可用性と分断耐性は保証されるが、一貫性が低いパターンのこと。

例はいつも通りとして、AP パターンを実現するには以下の設計が必要なる。

- 一方のノードがダウンした場合はもう一方のノードがそれを察知して単独でサービスを継続する(可用性)
- ２つのノード間のネットワークが分断された場合はそれぞれのノードが持つデータを用いてサービスを継続される(分断耐性)

この設計の問題はネットワーク分断時でもデータを返すため、最新データであることを保証できないことである。

言い換えると、ノード A,B に対してクライアントがデータを要求した場合、A,B は異なったデータを返却する場合があるため、一貫性が低下してしまう。

## RDB に CAP 定理を当てはめるとどうなるか？

RDB はデータの整合性が重要視されていた時代に生まれたもので、設計思想に ACID の概念が強く反映されている。

つまり、CAP 定理で言うところの Consistency(一貫性)が重要視されている。

そんな感じで、CAP 定理に当てはめて RDB を運用するときに一番強いのは、単一データベースサーバとして運用する CA パターンらしい。

## まとめ

- CAP 定理とは一貫性、可用性、分断耐性の全てを同時に保証するのは困難であることを説明した理論
- 一貫性とは返却されるデータが「最新」か「エラー」であることを保証する性質
- 可用性はあるノードで起きた障害が生存ノードに影響しないことを保証する性質
- 分断耐性はそれぞれのノードが通信できない状態でもサービスを継続できることを保証する性質
- CA パターンは一貫性と可用性は保証されるが、ネットワークが分断時はその限りではないパターン
- CP パターンは一貫性と分断耐性は保証されるが、ネットワーク分断時に利用できないサービスが出現するため可用性が低下するパターン
- AP パターンは可用性と分断耐性は保証されるが、ネットワーク分断時にそれぞれのノードで異なるデータを返却する可能性があるため、一貫性が低下するパターン
- RDB は歴史的な経緯もあって、一貫性に強く、単一サーバでサービスを展開するときは CA パターンの実現が容易である

## 参考文献

Wild Data Chase -データを巡る冒険-
メガネがデータと奮闘する log | ACID 特性 と CAP 定理 について勉強してみた
(最終閲覧日：2021 年 1 月 21 日）
http://wild-data-chase.com/index.php/2019/05/01/post-724/

Qiita | RDB の限界と NoSQL の登場
(最終閲覧日：2021 年 1 月 21 日）
https://qiita.com/1amageek/items/3dbbc3112493a73880d0

まさわん商店。～豚肉卸売問屋直営店～ | 「RDBMS」と「NoSQL」の比較
(最終閲覧日：2021 年 1 月 21 日）
https://masawan-guitar.hatenablog.com/entry/2016/08/14/163447
