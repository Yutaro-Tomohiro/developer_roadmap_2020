# Memory Management
## メモリとは何か？
コンピュータの主記憶装置。
主な仕事はCPUが処理するのに必要なデータを記憶しておくこと。

CPUとメモリの関係を料理をする時に例えると、CPUの役割がコックで、メモリの役割が食材を調理するためのキッチン。
調理スペースが広いほど、効率よく調理できる。

余談だが、個人的にはHDDなどの補助記憶装置が冷蔵庫の役割にあたると思う。

## メモリマネジメントは何か？
メモリ管理は実記憶管理と仮想記憶管理の２つがある。

実記憶管理は限られた主記憶空間を効率よく使えるようにプログラムを割り当てること。

仮想記憶は主記憶や補助記憶の存在をCPU側から隠蔽することで、広大なメモリ空間を自由に扱えるようにするもの。

## 実記憶管理について
### フラグメンテーション
フラグメンテーションとは、断片化を意味する。

メモリに複数のプログラムをロードさせる時、メモリ領域を有効活用するため、隙間なく詰め込む。
しかし、プログラムは詰め込んだ順に終了するわけではないので、虫食い穴のように小さな空き領域が飛び飛びにできてしまう。

このように合計ではまとまった空きのメモリ領域が存在するが、実際は小さな断片化せれた領域が散らばっている状態をフラグメンテーションという。

### メモリコンパクション
ロードされているプログラムを再配置して、連続した領域を確保することで、フラグメンテーションを解消できる。

この操作をメモリコンパクション、またはガベージコレクションという。

<!-- ### オーバーレイ方式 -->
### スワッピング方式
マルチプログラミング環境では優先度が高いプログラムが発生した場合、割り込みなどを行ってプログラムをロードする。

とはいえ、ロードしたくても空き容量がなくてロードできない場面の時もある。

この時に優先度の低いプログラムが使っていたメモリ領域の内容をいったん補助記憶装置に退避させて、優先度が高いプログラムをロードするための空き領域作る。このいったん退避させる処理をスワップアウトという。

優先度が高いプログラムの処理が終わった後は、退避させておいたプログラムをメモリ領域に再ロードして、中断箇所から処理を再開させる。この際ロードする処理をスワップインという。

スワップアウトとスワップインを合わせた処理をスワッピングと呼ぶ。

スワッピングが行われると補助記憶装置にアクセスするので処理速度が著しく低下する。

## 仮想記憶管理について
### 仮想記憶管理の仕組み
例えば32bit版のOSでは、２の３２乗で表せる数の範囲を仮想アドレス空間として持っている。
その範囲内に好きな様に領域を確保させることができる。

実際のデータは実記憶上に保存されるが、CPU側は仮想メモリのアドレスを参照するため、対応付けさえできていれば実記憶上のどこにデータがあっても関係ないので、バラバラにして空いているスペースに保存することができる。

このことにより実記憶上に配置するときの様々な制約を考えずにすむ様になる。

仮想アドレスと実アドレスの対応付けはMMUというCPUに組み込まれたハードウェアが担当する。
この様な仕組みを動的アドレス変換という。

仮想記憶の仕組みはなんか難しそうだが、この様な仕組みは本屋さんを想像すると分かりやすい…かもしれない。

本屋で仮想記憶にあたるのが在庫リスト、メモリが売り場の書棚、補助記憶装置がバックヤードの倉庫になる。

在庫リストを見てまずはメインの場所となるお店の書棚に探しているものがあるか確認する。
書棚にない場合はバックヤードの倉庫から探している本を引っ張り出してくる。

この様に在庫リストを見れば探している本が一目瞭然で分かる。
### ページング方式
ページング方式とは仮想アドレス空間を固定長の領域に区切って管理する仮想記憶の実装方式のこと。

仮想記憶と実記憶の対応付けはページテーブルという表によって管理されている。

この表で仮想ページ番号が実記憶上のどのページと結びついているかが確認できる。

ページテーブルには実記憶上に存在するかどうかのフラグがあり、実記憶上になければ補助記憶から実記憶に読みこむ。
この読み込む作業をページインという。

逆に実記憶から補助記憶へと追い出すことをページアウトという。

## 参考文献
きたみりゅうじ, キタミ式イラストIT塾基本情報技術者, 技術評論社, 2011初版

