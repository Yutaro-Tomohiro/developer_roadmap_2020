# Sharding Strategies

## シャーディングとは

シャーディングとはデータを複数の DB に分散して保持する方法のこと。

水平分割とも言う。

分散のやり方は例えば id をある数で割って、剰余が０ならあの DB、剰余が２
ならこの DB みたいなやり方とかがある。

## シャーディングのメリット

### 書き込みに対しても負荷分散できる

シャーディングはレプリケーションとは違い、DB を読み込みや書き込みといった役割で分けないので、更新系クエリが多い DB でも負荷分散ができる。

### ALTER TABLE が速い

DB の項目追加や削除といったテーブル定義の変更(ALTER TABLE)が早いメリットもある。

ALTER TABLE を行うと内部的に以下のような処理を行っている。

- 変更後の定義でテーブルを新規作成
- 変更前のテーブルのデータを変更後のテーブルに全件登録
- 変更前後のテーブルの名前の入れ替え
- 変更前のテーブルの削除

変更前のテーブルのデータが多いほど時間がかかるのは容易に想像できるが、シャーディングによって DB が n 台あれば単純計算で１台あたりのデータ量も 1/n になる。

この n 台が並行して ALTER TABLE を実行すれば処理時間も 1/n になるため、ALTER TABLE は早くなる。

## シャーディングのデメリット

### オートインクリメント値の採番が面倒

分散する各サーバで別々にオートインクリメントで ID を採番した場合、サーバ間で ID の重複が発生するため、回避するための対策が必要になる。

例えば、分散しない DB のみでオートインクリメントを行い、採番された値で分散先の各サーバにデータを登録するといった対策が必要になる。

### サーバーを跨ぐクエリに弱い

サーバを跨いでの結合やソートなどは実装が複雑になるかつ、処理速度も落ちてしまう。

### DB の台数を増やしづらい

レプリケーションに比べて DB を増やすのが面倒なことが多い。

レプリケーションで DB を増やす場合、データをコピーしたスレーブを増やすだけでいいが、シャーディングの場合はデータの振り分けし直す必要があるため、DB の台数を増やしづらい。

## まとめ

- シャーディングとはデータを分散して保持する方法のこと
- メリットとして、書き込み処理に対しても負荷分散できたり、ALTER TABLE が早いなどがある
- デメリットとしてオートインクリメント、サーバを跨ぐクエリ、DB の台数を増やすことは苦手

## 参考文献

O-TWO BLOG | 【MySQL】Spider ストレージエンジンによる水平分散(シャーディング)
(最終閲覧日：2021 年 1 月 21 日）
http://www.otwo.jp/blog/mysql-spider/

猫でもわかる Web プログラミング | レプリケーションとシャーディング、MySQL でレプリケーションの張り方
(最終閲覧日：2021 年 1 月 21 日）
https://www.utakata.work/entry/2017/12/04/104639

LINE Engineering | LINE マンガのデータベースをシャーディングしました (データベースエンジニア編)
(最終閲覧日：2021 年 1 月 21 日）
https://engineering.linecorp.com/ja/blog/line-manga-database/

GeekHash | Sharding とは
(最終閲覧日：2021 年 1 月 21 日）
https://medium.com/teamgeekhash/sharding-%E3%81%A8%E3%81%AF-7731655b0391
