# ACID

## ACID とは

トランザクションには 4 つの特性が標準規格によって決められている。

ACID は，原子性(Atomicity)/一貫性(Consistency)/独立性(Isolation)/永続性(Durability)の４特性のことを指している。

### 原子性(Atomicity)

原子性とは処理がこれ以上分割できないことを意味する。

つまり、トランザクション処理は一連の処理が正しく終了するか、処理が始まっていないかの２択であり、中途半端に終わらないことを保証する性質のこと。

### 一貫性(Consistency)

一貫性とは、トランザクションが開始時と完了時でデータベースの条件を満たすことを保証する性質のこと。

例えば口座に 1 万円しかないのに 3 万円を振り込もうとした時、残額不足になるので、ロールバックするみたいな感じ。

### 独立性(Isolation)

独立性とは、同時に実行された複数のトランザクションはお互いに干渉しないという性質のこと。

### 永続性(Durability)

永続性とは、トランザクションがコミットされると、停電やクラッシュなどのシステム障害の場合でもコミットされたままになることを保証する性質のこと。
耐久性とも呼ばれる。

この性質の保証のために、一般的にはトランザクションのログを記録しておき、障害が起きた場合はログを使用して障害発生前の状態に復旧する。

## MySQL で原子性を実現させる機能

- 自動コミット設定
- COMMIT 構文
- ROLLBACK 構文
- INFORMATION_SCHEMA テーブルの運用データ

### INFORMATION_SCHEMA について

INFORMATION_SCHEMA には MySQL サーバーが持つ全てのデータベースに関する情報が格納されている。

## MySQL で一貫性を実現させる機能

- 二重書き込みバッファー
- クラッシュリカバリ

### 二重書き込みバッファーについて

MySQL では値をデータファイルに書き込む前に二重書き込みバッファーと呼ばれる連続領域に書き込む。

二重書き込みバッファーへの書き込みとフラッシュが完了した後にはじめて、それらのページをデータファイル内の適切な位置に書き込みする。

ページ書き込みの最中にオペレーティングシステム、ストレージサブシステム、または mysqld プロセスのクラッシュが発生した場合、MySQL ではクラッシュリカバリ中にそのページの正常なコピーを二重書き込みバッファーから復帰させることができる。

### クラッシュリカバリについて

クラッシュリカバリは MySQL が再起動した時に行われる機能のこと。

トランザクションが不完全だった場合、Redo ログからのデータを使用して復帰させる。

クラッシュ前にコミットされたが、データファイルに書き込まれていない場合は二重書き込みバッファーから復帰させる。

## MySQL で独立性を実現させる機能

- 自動コミット設定
- SET ISOLATION LEVEL 構文
- ロック機能

### SET ISOLATION LEVEL 構文について

トランザクションの分離レベルを指定する構文。

分離レベルには以下の４つがある。下に行くほど分離レベルが上がるイメージ

- READ UNCOMMITTED
- READ COMMITTED
- REPEATABLE READ
- SERIALIZABLE

分離レベルが不十分だと、以下の 3 つの問題が起こるとされている。

- ダーティリード
  - トランザクション B でコミットされていないデータをトランザクション A で読み取ってしまう
- ノンリピータブルリード
  - トランザクション A でデータを複数回読み取っている途中にトランザクション B でデータを更新してコミットした場合、トランザクション A で違う結果のデータを読み取ってしまう
- ファントムリード
  - トランザクション A で一定の範囲のレコードに対して処理を行っている途中にトランザクション B でデータを追加・削除してコミットした場合、トランザクション A で幻影のようにデータが反映されるため、処理の結果が変わってしまう

以上のような問題をどの程度許容するかによって分離レベルを決める。

分離レベルと発生する問題は以下の表のようにまとめられる。

| 分離レベル       | ダーティリード | ノンリピータブルリード | ファントムリード |
| ---------------- | -------------- | ---------------------- | ---------------- |
| READ UNCOMMITTED | ○              | ○                      | ○                |
| READ COMMITTED   | ×              | ○                      | ○                |
| REPEATABLE READ  | ×              | ×                      | ○                |
| SERIALIZABLE     | ×              | ×                      | ×                |

○：発生する ×：発生しない

ちなみに InnoDB では REPEATABLE READ でもファントムリードが発生しない。

### ロック機能について

他のトランザクションによって、参照、変更されているデータをトランザクションが参照したり、変更したりすることを防止するシステム。

## MySQL で永続性を実現させる機能

- innodb_doublewrite 構成オプションでオンとオフが切り替え
- 二重書き込みバッファー
- innodb_flush_log_at_trx_commit 構成オプション
- sync_binlog 構成オプション
- innodb_file_per_table 構成オプション
- ストレージデバイス内の書き込みバッファー (ディスクドライブ、SSD、RAID アレイなど)
- ストレージデバイス内のバッテリーでバックアップされるキャッシュ
- MySQL を実行する際に使用されるオペレーティングシステム (特に、fsync() システムコールでのサポート)
- MySQL サーバーを実行し、MySQL データを格納するすべてのコンピュータサーバーおよびストレージデバイスへの電力を保護する無停電電源装置 (UPS)
- バックアップ方針 (頻度、バックアップのタイプ、バックアップの保存期間など)
- 分散型またはホスト型のデータアプリケーションの場合、MySQL サーバー用のハードウェアが配置されているデータセンター、およびデータセンター間のネットワーク接続の特定の特性

## innodb_doublewrite について

- この変数を有効にすると、すべてのデータが二重書き込みバッファー、実際のデータファイルの順に格納される
- デフォルトでは有効
- --skip-innodb_doublewrite を使用すれば無効できる
- https://dev.mysql.com/doc/refman/5.6/ja/innodb-parameters.html#sysvar_innodb_doublewrite

## sync_binlog について

- 変数の値が 0 より大きい場合は sync_binlog コミットグループがバイナリログに書き込まれた後に、バイナリログをディスクに同期する
- デフォルト値は 0
- https://dev.mysql.com/doc/refman/5.6/ja/replication-options-binary-log.html

## innodb_file_per_table について

- 有効になっている場合は新たに作成された各テーブルのデータおよびインデックスがシステムテーブルスペースではなく、個別の .ibd ファイルに格納される
- 5.6.6 以上のデフォルト
- innodb_file_per_table を無効にすると、すべてのテーブルおよびインデックス用のデータが、システムテーブルスペースを構成する ibdata ファイルに格納される
- https://dev.mysql.com/doc/refman/5.6/ja/innodb-parameters.html#sysvar_innodb_file_per_table

## 参考文献

PROMAPEDIA | トランザクションの ACID 特性とは何か？(最終閲覧日：2020 年 12 月 7 日）
https://ssaits.jp/promapedia/technology/acid.html#toc_id_3_4

MySQL | InnoDB and the ACID Model(最終閲覧日：2020 年 12 月 7 日）
https://dev.mysql.com/doc/refman/5.6/ja/mysql-acid.html

Qiita | トランザクション分離レベルについてのまとめ(最終閲覧日：2020 年 12 月 7 日）
https://qiita.com/song_ss/items/38e514b05e9dabae3bdb

CUBE SUGAR CONTAINER | MySQL の InnoDB でトランザクション分離レベルの違いを試す(最終閲覧日：2020 年 12 月 7 日）
https://blog.amedama.jp/entry/mysql-innodb-tx-iso-levels
